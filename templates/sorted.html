
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/icon.png') }}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <title>StepSort - Resultado</title>

    <style>
        body {
            background: #0d0d0d;
            color: #f0f0f0;
            padding: 25px;
            -webkit-font-smoothing: antialiased;
        }

        .container-box {
            max-width: 1000px;
            margin: auto;
            background: rgba(255,255,255,0.06);
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 0 18px rgba(0,0,0,0.5);
        }

        .info-card {
            background: rgba(255,255,255,0.06);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        /* steps area */
        #steps {
            max-height: 520px;
            overflow-y: auto;
            padding: 16px;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .step-card {
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.04);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .step-top {
            display:flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .step-title {
            font-weight: 700;
            color: #f8dc4c;
        }

        .step-sub {
            color: rgba(255,255,255,0.75);
            font-size: 0.90rem;
        }

        .array-line {
            margin-top: 10px;
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            align-items:center;
        }

        .array-badge {
            background: rgba(255,255,255,0.03);
            color: #e6e6e6;
            border-radius: 999px;
            padding: 6px 10px;
            font-weight: 600;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .array-badge.swap {
            background: #f8dc4c;
            color: #000;
            box-shadow: 0 2px 6px rgba(248,220,76,0.08);
            transform: translateY(-1px);
        }

        .controls {
            display:flex;
            gap:8px;
            justify-content:flex-end;
            margin-bottom:10px;
        }

        .status-block {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            margin-bottom:8px;
        }

        .small-muted {
            color: rgba(255,255,255,0.65);
            font-size: 0.9rem;
        }

        /* keep your button styles */
        .btn-custom {
            background: #28cee3;
            color: black;
            border-radius: 10px;
            font-weight: bold;
            border: none;
        }
        .btn-custom:hover { background: #1bb1c6; }

        .btn-yellow {
            background: #f8dc4c;
            color: black;
            border-radius: 10px;
            font-weight: bold;
            border: none;
        }
        .btn-yellow:hover { background: #e6c839; }

        /* footer buttons look */
        .footer-links a {
            display: inline-block;
            padding: 10px 18px;
            border-radius: 10px;
            border: 2px solid #ffffff;
            color: #ffffff;
            text-decoration: none;
            transition: 0.25s;
        }
        .footer-links a:hover { background: rgba(255,255,255,0.12); }
    </style>

</head>

<body>

<div class="container-box">

    <h1 class="mb-4 text-center"> Execução de Ordenação</h1>

    <div class="info-card">
        <h5><i class="bi bi-person-fill"></i> Usuário: <span class="text-info">{{ player }}</span></h5>
        <h5><i class="bi bi-diagram-3-fill"></i> Algoritmo: <span class="text-warning">{{ method }}</span></h5>
        <h5><i class="bi bi-bar-chart-fill"></i> Complexidade: {{ complexity }}</h5>
        <h5><i class="bi bi-list-ol"></i> Comparações: {{ comparisons }} | Trocas: {{ swaps }}</h5>
        <h5><i class="bi bi-stopwatch-fill"></i> Tempo: <span class="text-warning">{{ elapsed_time }}s</span></h5>
        <h5><i class="bi bi-braces"></i> Lista Original: {{ originalArr }}</h5>
        <h5><i class="bi bi-check-circle-fill text-info"></i> Resultado Final: <span class="text-info">{{ sortedArr }}</span></h5>
    </div>

    <div class="mt-3 mb-4 text-center">
        {% if method != 'Sort Padrão (Python)' %}
            <button class="btn btn-custom me-2" data-bs-toggle="modal" data-bs-target="#scenarioModal">
                <i class="bi bi-graph-up-arrow"></i> Melhor/Pior Cenário
            </button>

            <button class="btn btn-yellow" data-bs-toggle="modal" data-bs-target="#compareModal">
                <i class="bi bi-graph-up"></i> Comparar Algoritmos
            </button>
        {% endif %}
    </div>

    {% if show_steps %}
        <h2 class="mt-4"><i class="bi bi-list-check text-info"></i> Processo de Ordenação</h2>

        <div class="status-block">
            <div class="small-muted" id="animation-status">Iniciando animação...</div>
            <div class="small-muted" id="status-count">0 / 0</div>
        </div>

        <!-- controls (non-destructive, purely UI) -->
<div class="controls">
    <button id="btnPause" class="btn btn-sm btn-outline-light" type="button" title="Pausar/Retomar">
        <i id="iconPause" class="bi bi-pause"></i>
    </button>
    <button id="btnStepBack" class="btn btn-sm btn-outline-light" type="button" title="Voltar 1 passo">
        <i class="bi bi-caret-left-fill"></i>
    </button>
    <button id="btnStepForward" class="btn btn-sm btn-outline-light" type="button" title="Avançar 1 passo">
        <i class="bi bi-caret-right-fill"></i>
    </button>
</div>

        <!-- progress -->
        <div class="mb-3">
            <div class="progress" style="height:8px; border-radius:8px; background: rgba(255,255,255,0.03);">
                <div id="progress-bar" class="progress-bar bg-info" role="progressbar" style="width:0%"></div>
            </div>
        </div>

        <div id="steps" aria-live="polite" aria-atomic="true"></div>

<script>
// ----------------------------------------------------
// Executa quando todo o DOM estiver carregado
// ----------------------------------------------------
document.addEventListener('DOMContentLoaded', function () {
    // stepsData: array com todas as etapas do algoritmo enviado pelo backend (Flask/Jinja)
    const stepsData = {{ steps | tojson }};

    // referências aos elementos da página
    const stepsContainer = document.getElementById("steps"); // div onde as etapas serão exibidas
    const statusElement = document.getElementById("animation-status"); // texto de status
    const statusCount = document.getElementById("status-count"); // contador de passos
    const progressBar = document.getElementById("progress-bar"); // barra de progresso

    // índice da etapa atual e total de etapas
    let currentStep = 0;
    const totalSteps = stepsData.length;

    const animationSpeed = 50; // tempo em ms entre cada etapa

    // controle de reprodução
    let playing = true;
    let stepTimeout = null;

    // ícone do botão de pause/play
    const iconPause = document.getElementById('iconPause');

    // ----------------------------------------------------
    // Função auxiliar: renderiza uma "card" com a etapa
    // ----------------------------------------------------
    function renderStepCard(stepIndex, listState, swap) {
        const card = document.createElement('div');
        card.className = 'step-card';

        // topo do card com título e swap
        const top = document.createElement('div');
        top.className = 'step-top';

        const title = document.createElement('div');
        title.className = 'step-title';
        title.innerHTML = `<i class="bi bi-arrow-left-right"></i> ${stepIndex}. Troca`;

        const sub = document.createElement('div');
        sub.className = 'step-sub';
        sub.textContent = `Swap: ${swap[0]} ↔ ${swap[1]}`;

        top.appendChild(title);
        top.appendChild(sub);
        card.appendChild(top);

        // linha com os elementos da lista
        const arrayLine = document.createElement('div');
        arrayLine.className = 'array-line';

        // cria badges para cada elemento
        for (let v of listState) {
            const b = document.createElement('span');
            b.className = 'array-badge';
            if (v === swap[0] || v === swap[1]) { // destaca elementos trocados
                b.classList.add('swap');
            }
            b.textContent = v;
            arrayLine.appendChild(b);
        }
        card.appendChild(arrayLine);

        // rodapé do card indicando o estado atual
        const footer = document.createElement('div');
        footer.className = 'small-muted mt-2';
        footer.textContent = `Estado após etapa ${stepIndex}`;
        card.appendChild(footer);

        return card; // retorna o card pronto
    }

    // ----------------------------------------------------
    // Atualiza o status da animação e a barra de progresso
    // ----------------------------------------------------
    function updateStatus(stepIndex) {
        statusElement.textContent = stepIndex === 0
            ? 'Iniciando animação...'
            : `Mostrando etapa ${stepIndex} de ${totalSteps}...`;
        statusCount.textContent = `${stepIndex} / ${totalSteps}`;

        const pct = totalSteps === 0 ? 0 : Math.round((stepIndex / totalSteps) * 100);
        progressBar.style.width = `${pct}%`;
    }

    // ----------------------------------------------------
    // Mostra a próxima etapa na tela
    // ----------------------------------------------------
    function showNextStep() {
        if (currentStep >= totalSteps) { // se acabou
            updateStatus(totalSteps);
            statusElement.textContent = `Animação concluída! (${totalSteps} etapas)`;
            return;
        }

        const step = stepsData[currentStep];
        const listState = step[0]; // estado atual da lista
        const swap = step[1];      // elementos trocados
        const stepIndex = currentStep + 1;

        const card = renderStepCard(stepIndex, listState, swap);
        stepsContainer.appendChild(card);
        stepsContainer.scrollTop = stepsContainer.scrollHeight; // rola para o final

        currentStep++;
        updateStatus(currentStep);

        if (playing) { // se em reprodução automática
            stepTimeout = setTimeout(showNextStep, animationSpeed);
        }
    }

    // ----------------------------------------------------
    // Botão Pause / Play
    // ----------------------------------------------------
    document.getElementById('btnPause').addEventListener('click', () => {
        playing = !playing;
        if (playing) {
            if (currentStep < totalSteps) {
                stepTimeout = setTimeout(showNextStep, animationSpeed);
            }
            iconPause.classList.remove('bi-play');
            iconPause.classList.add('bi-pause');
        } else {
            if (stepTimeout) { clearTimeout(stepTimeout); stepTimeout = null; }
            iconPause.classList.remove('bi-pause');
            iconPause.classList.add('bi-play');
        }
    });

    // ----------------------------------------------------
    // Botão Avançar 1 passo
    // ----------------------------------------------------
    document.getElementById('btnStepForward').addEventListener('click', () => {
        if (playing && stepTimeout) {
            clearTimeout(stepTimeout);
            stepTimeout = null;
            playing = false;
            iconPause.classList.remove('bi-pause');
            iconPause.classList.add('bi-play');
        }
        if (currentStep < totalSteps) showNextStep();
    });

    // ----------------------------------------------------
    // Botão Voltar 1 passo
    // ----------------------------------------------------
    document.getElementById('btnStepBack').addEventListener('click', () => {
        if (playing && stepTimeout) {
            clearTimeout(stepTimeout);
            stepTimeout = null;
            playing = false;
            iconPause.classList.remove('bi-pause');
            iconPause.classList.add('bi-play');
        }
        if (currentStep > 0) {
            const last = stepsContainer.lastElementChild; // remove último card
            if (last) stepsContainer.removeChild(last);
            currentStep--;
            updateStatus(currentStep);
        }
    });

    // ----------------------------------------------------
    // Inicializa status e começa a animação automática
    // ----------------------------------------------------
    updateStatus(0);

    if (totalSteps > 0) {
        stepTimeout = setTimeout(showNextStep, animationSpeed);
    } else {
        statusElement.textContent = 'Nenhuma etapa para exibir.';
    }
});
</script>


    {% else %}
        <h2 class="mt-4 text-warning">
            <i class="bi bi-exclamation-triangle-fill"></i>
            Lista muito grande ({{ originalArr|length }} itens). Etapas não exibidas.
        </h2>
    {% endif %}

    <div class="footer-links mt-4 text-center">
        <a href="{{ url_for('index') }}" class="me-2"><i class="bi bi-arrow-left-circle"></i> Nova Ordenação</a>
        <a href="{{ url_for('history') }}"><i class="bi bi-clock-history"></i> Ver Histórico</a>
    </div>

</div>

<!-- MODALS kept unchanged -->
<div class="modal fade" id="scenarioModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="bi bi-graph-up-arrow text-info"></i>
                    Melhor e Pior Cenário — {{ method }}
                </h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="info-card">
                    <h4><i class="bi bi-bar-chart-fill"></i> Complexidade: <span>{{ complexity }}</span> </h4>
                </div>
                <div class="info-card">
                    <h4><i class="bi bi-arrow-up-circle-fill"></i> Melhor Cenário - {{melhor_caso_notacao}}</h4>
                    <p>{{ scenario_data.best_arr }}</p>
                    <p>Tempo: <span class="text-info">{{ scenario_data.best_results.time }}s</span></p>
                    <p>Comparações: {{ scenario_data.best_results.comp }} | Trocas: {{ scenario_data.best_results.swap }}</p>
                </div>
                <div class="info-card">
                    <h4><i class="bi bi-arrow-right-circle-fill"></i> Cenário Médio - {{caso_medio_notacao}}</h4>
                    <p>{{ scenario_data.average_arr }}</p>
                    <p>Tempo: <span class="text-info">{{ scenario_data.average_results.time }}s</span></p>
                    <p>Comparações: {{ scenario_data.average_results.comp }} | Trocas: {{ scenario_data.average_results.swap }}</p>
                </div>
                <div class="info-card">
                    <h4><i class="bi bi-arrow-down-circle-fill"></i> Pior Cenário - {{pior_caso_notacao}}</h4>
                    <p>{{ scenario_data.worst_arr }}</p>
                    <p>Tempo: <span class="text-warning">{{ scenario_data.worst_results.time }}s</span></p>
                    <p>Comparações: {{ scenario_data.worst_results.comp }} | Trocas: {{ scenario_data.worst_results.swap }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="compareModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="bi bi-bar-chart-steps text-warning"></i>
                    Comparação de Algoritmos
                </h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="info-card">
                    <h4><i class="bi bi-circle-fill text-info"></i> Bubble Sort</h4>
                    <p>Tempo: <span class="text-info">{{ comparison_data.bubble.time }}s</span></p>
                    <p>Comparações: {{ comparison_data.bubble.comp }} | Trocas: {{ comparison_data.bubble.swap }}</p>
                    <form method="post">
                        <input type="text" class="form-control mb-3 d-none" value="{{ player }}" name="player" id="player" placeholder="Seu nome" required>
                        <input type="hidden" value="{{ numbers }}" name="numbers" id="hiddenNumbers">
                        <input class="form-check-input d-none" type="radio" id="bubbleSort" name="sorting" value="bubbleSort" checked>
                        <button type="submit" class="btn btn-info">Ver Bubble Sort</button> 
                    </form>
                </div>
                <div class="info-card">
                    <h4><i class="bi bi-square-fill text-warning"></i> Selection Sort</h4>
                    <p>Tempo: <span class="text-warning">{{ comparison_data.selection.time }}s</span></p>
                    <p>Comparações: {{ comparison_data.selection.comp }} | Trocas: {{ comparison_data.selection.swap }}</p>
                    <form method="post">
                        <input type="text" class="form-control mb-3 d-none" value="{{ player }}" name="player" id="player" placeholder="Seu nome" required>
                        <input type="hidden" value="{{ numbers }}" name="numbers" id="hiddenNumbers">
                        <input class="form-check-input d-none" type="radio" id="selectionSort" name="sorting" value="selectionSort" checked>
                        <button type="submit" class="btn btn-warning">Ver Selection Sort</button> 
                    </form>
                </div>
                 <div class="info-card">
                    <h4><i class="bi bi-square-fill text-danger"></i> Insertion Sort</h4>
                    <p>Tempo: <span class="text-danger">{{ comparison_data.insertion.time }}s</span></p>
                    <p>Comparações: {{ comparison_data.insertion.comp }} | Trocas: {{ comparison_data.insertion.swap }}</p>
                    <form method="post">
                        <input type="text" class="form-control mb-3 d-none" value="{{ player }}" name="player" id="player" placeholder="Seu nome" required>
                        <input type="hidden" value="{{ numbers }}" name="numbers" id="hiddenNumbers">
                        <input class="form-check-input d-none" type="radio" id="insertionSort" name="sorting" value="insertionSort" checked>
                        <button type="submit" class="btn btn-danger">Ver Insertion Sort</button> 
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
